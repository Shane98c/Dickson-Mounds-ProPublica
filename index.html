<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Tragedy of North Birmingham</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/scrollama@3.2.0/build/scrollama.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        top: 0;
        height: 100vh;
        width: 100vw;
        max-width: 100%;
        position: sticky;
      }

      #features {
        pointer-events: none;
        padding-bottom: 10vh;
        transform: translate3d(0, 0, 0);
      }
      #features:last-of-type {
        padding-bottom: 100vh;
      }
      .hidden {
        visibility: hidden;
      }
      .centered {
        width: 90vw;
        max-width: 550px;
        margin: 0 auto;
      }
      .lefty {
        width: 33vw;
        max-width: 550px;
        margin-left: 5vw;
      }
      .step {
        z-index: 100;
        padding-bottom: 10vh;
        opacity: 0.95;
      }
      .step div {
        pointer-events: auto;
        padding: 15px 25px;
        line-height: 1.5rem;
        font-size: 1.1rem;
        font-family: "Tiempos Text", serif;
        box-shadow: 2px 3px 10px rgb(0 0 0 / 50%);
        color: #c3bfb5;
        background-color: rgba(29, 29, 29);
        border-radius: 6px;
      }
      .step p {
        margin: 0px;
      }

      .step a {
        color: #c3bfb5;
      }

      @media (max-width: 750px), (max-height: 750px) {
        .centered,
        .lefty,
        .righty,
        .fully {
          width: 95vw;
          margin: 0 auto;
        }
        .step div {
          line-height: 1.2em;
          padding: 10px 15px;
          font-size: 1em;
        }
      }

      /* Fix issue on mobile browser where scroll breaks  */
      .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
      .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan
        .mapboxgl-canvas {
        touch-action: unset;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="story"></div>

    <script src="./config.js"></script>
    <script src="./ceded_IL_selectFields.js"></script>

    <script>
      const layerTypes = {
        fill: ["fill-opacity"],
        line: ["line-opacity"],
        circle: ["circle-opacity", "circle-stroke-opacity"],
        symbol: ["icon-opacity", "text-opacity"],
        raster: ["raster-opacity"],
      };

      const alignments = {
        left: "lefty",
        center: "centered",
        full: "fully",
      };

      function getLayerPaintType(layer) {
        const layerType = map.getLayer(layer).type;
        return layerTypes[layerType];
      }

      function setLayerOpacity(layer) {
        const paintProps = getLayerPaintType(layer.layer);
        paintProps.forEach(function (prop) {
          let options = {};
          if (layer.duration) {
            const transitionProp = prop + "-transition";
            options = { duration: layer.duration };
            map.setPaintProperty(layer.layer, transitionProp, options);
          }
          map.setPaintProperty(layer.layer, prop, layer.opacity, options);
        });
      }

      const story = document.getElementById("story");
      const features = document.createElement("div");
      features.setAttribute("id", "features");

      ceded.features.forEach((record, idx) => {
        const container = document.createElement("div");
        const chapter = document.createElement("div");

        container.setAttribute("id", record.properties.id);
        container.classList.add("step");

        container.appendChild(chapter);
        container.classList.add("centered");
        // container.classList.add("hidden");
        const story = document.createElement("p");

        story.innerHTML = record.properties.year;
        chapter.appendChild(story);

        features.appendChild(container);
      });

      story.appendChild(features);

      mapboxgl.accessToken = config.accessToken;

      const map = new mapboxgl.Map({
        container: "map",
        style: config.style,
        projection: {
          name: "lambertConformalConic",
          center: config.start.center,
          parallels: [30, 36],
        },
        bounds: config.start.bounds,
        interactive: false,
        attributionControl: false,
      });
      map.addControl(
        new mapboxgl.AttributionControl({
          customAttribution: "ProPublica, USDA",
          compact: true,
        })
      );

      const scroller = scrollama();

      function addAnimateLayers() {
        const source = "ceded";
        map.addSource(source, {
          promoteId: "id",
          type: "geojson",
          data: ceded,
        });
        map.addLayer(
          {
            id: source,
            type: "fill",
            source: source,
            layout: {},
            paint: {
              "fill-color": "white",
              "fill-opacity": [
                "case",
                ["boolean", ["feature-state", "selected"], false],
                0.5,
                0,
              ],
              "fill-opacity-transition": {
                duration: 1000,
                delay: 0,
              },
            },
          },
          "water"
        );
      }

      map.on("load", function () {
        addAnimateLayers();
        scroller
          .setup({
            step: ".step",
            offset: 0.5,
            progress: false,
          })
          .onStepEnter((response) => {
            console.log(response);
            function setState(state) {
              // if (!state) map.removeFeatureState({source: 'ceded'})
              map.setFeatureState(
                {
                  source: "ceded",
                  id: response.element.id,
                },
                {
                  selected: state,
                }
              );
            }
            if (response.direction === "down") {
              setState(true);
            } else {
              setState(false);
            }
          })
          .onStepExit((response) => {
            // const chapter = config.chapters.find(
            //   (chap) => chap.id === response.element.id
            // );
            // if (chapter.onChapterExit.length > 0) {
            //   chapter.onChapterExit.forEach(setLayerOpacity);
            // }
            // if (chapter.exitCallback) {
            //   window[chapter.exitCallback]();
            // }
            // if (response.index === 0 && response.direction === "up") {
            //   map.fitBounds(config.start.bounds);
            // }
          });
      });
    </script>
  </body>
</html>
