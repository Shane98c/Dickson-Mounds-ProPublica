<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Tragedy of North Birmingham</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!-- <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css"
      rel="stylesheet"
    /> -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script src="https://unpkg.com/scrollama@3.2.0/build/scrollama.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        top: 0;
        height: 100vh;
        width: 100vw;
        max-width: 100%;
        position: sticky;
      }

      #features {
        pointer-events: none;
        padding-bottom: 10vh;
        transform: translate3d(0, 0, 0);
      }
      #features:last-of-type {
        padding-bottom: 100vh;
      }
      .hidden {
        visibility: hidden;
      }
      .centered {
        width: 90vw;
        max-width: 550px;
        margin: 0 auto;
      }
      .lefty {
        width: 33vw;
        max-width: 550px;
        margin-left: 5vw;
      }
      .step {
        z-index: 100;
        padding-bottom: 10vh;
        opacity: 0.95;
      }
      .step div {
        pointer-events: auto;
        padding: 15px 25px;
        line-height: 1.5rem;
        font-size: 1.1rem;
        font-family: "Tiempos Text", serif;
        box-shadow: 2px 3px 10px rgb(0 0 0 / 50%);
        color: #c3bfb5;
        background-color: rgba(29, 29, 29);
        border-radius: 6px;
      }
      .step p {
        margin: 0px;
      }

      .step a {
        color: #c3bfb5;
      }

      @media (max-width: 750px), (max-height: 750px) {
        .centered,
        .lefty,
        .righty,
        .fully {
          width: 95vw;
          margin: 0 auto;
        }
        .step div {
          line-height: 1.2em;
          padding: 10px 15px;
          font-size: 1em;
        }
      }

      /* Fix issue on mobile browser where scroll breaks  */
      .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
      .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan
        .mapboxgl-canvas {
        touch-action: unset;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="story"></div>

    <!-- <script src="./config.js"></script> -->
    <script src="./ceded_IL_selectFields.js"></script>

    <script>
      const layerTypes = {
        fill: ["fill-opacity"],
        line: ["line-opacity"],
        circle: ["circle-opacity", "circle-stroke-opacity"],
        symbol: ["icon-opacity", "text-opacity"],
        raster: ["raster-opacity"],
      };

      const alignments = {
        left: "lefty",
        center: "centered",
        full: "fully",
      };

      const story = document.getElementById("story");
      const features = document.createElement("div");
      features.setAttribute("id", "features");

      ceded.features.forEach((record, idx) => {
        const container = document.createElement("div");
        const chapter = document.createElement("div");

        container.setAttribute("id", record.properties.id);
        container.classList.add("step");

        container.appendChild(chapter);
        container.classList.add("centered");
        // container.classList.add("hidden");
        const story = document.createElement("p");

        story.innerHTML = record.properties.year;
        chapter.appendChild(story);

        features.appendChild(container);
      });

      story.appendChild(features);

      const scroller = scrollama();
      var selection = d3.select("#map");
      console.log(selection);
      const width = selection._groups[0][0].clientWidth;
      const height = selection._groups[0][0].clientHeight;

      const projection = d3
        .geoAlbers()
        .scale(10000)
        .rotate([89.2, 0])
        .center([0, 40])
        .translate([width / 2, height / 2]);

      const svg = d3
        .select("#map")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      svg
        .append("rect")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("fill", "#363636");

      const path = d3.geoPath().projection(projection);
      const cededGeo = svg.append("g");
      const ilGeo = svg.append("g");

      function makeMap(index) {
        const filtered = ceded.features.filter(function (feature) {
          return feature.properties.id > index;
        });
        console.log(filtered);
        d3.json("IL.geojson").then(function (geojson) {
          ilGeo
            .selectAll("path")
            .data(geojson.features)
            .enter()
            .append("path")
            .attr("fill", "#69b3a2")
            .attr("fill-opacity", 0)
            .attr("d", path)
            .style("stroke", "white")
            .attr("stroke-width", "3");
        });

        cededGeo
          .selectAll("path")
          .data(filtered, (d) => d.properties.id)
          .join(
            function (enter) {
              return (
                enter
                  .append("path")

                  .transition()
                  .duration(1000)

                  // .attr("opacity", 0)
                  .attr("fill", "white")
                  .attr("d", path)
                  .attr("opacity", 1)
                  .attr("fill-opacity", 0.4)

                  .style("stroke", "black")
              );
            },
            function (update) {
              return update;
            },
            function (exit) {
              return exit
                .transition()
                .duration(1000)
                .attr("transform", "translate(0," + height + ")")
                .attr("opacity", 0)
                .delay(200)
                .style("stroke", "black")
                .attr("stroke-width", "3")

                .remove();
            }
          );
      }

      makeMap(0);

      scroller
        .setup({
          step: ".step",
          offset: 0.5,
          progress: false,
        })
        .onStepEnter((response) => {
          const id = parseInt(response.element.id);
          makeMap(id);
          // const filtered = ceded.features.filter(function (feature) {
          //   return feature.properties.id <= parseInt(response.element.id);
          // });
          // console.log(filtered);
          // cededGeo
          //   .selectAll("path")
          //   .data(filtered, (d) => d.id)
          //   .enter()
          //   .append("path")
          //   .merge(cededGeo)
          //   .transition()
          //   .duration(1000)
          //   .attr("fill", "orange")
          //   .attr("opacity", 1)
          //   .style("stroke", "#fff");
          // console.log(response);
          // d3Layer
          //   .data(ceded.features)
          //   .filter(function (d) {
          //     return d.properties.id <= parseInt(response.element.id);
          //   })
          //   .enter()
          //   .append("path")
          //   .attr("fill", "#69b3a2")
          //   .attr("d", path)
          //   .style("stroke", "#fff");
          // d3.selectAll('cededGeo').filter(function(d) {
          //   console.log(d)
          //   return d.properties.id === response.element.id
          // }
        })
        .onStepExit((response) => {
          // const chapter = config.chapters.find(
          //   (chap) => chap.id === response.element.id
          // );
          // if (chapter.onChapterExit.length > 0) {
          //   chapter.onChapterExit.forEach(setLayerOpacity);
          // }
          // if (chapter.exitCallback) {
          //   window[chapter.exitCallback]();
          // }
          // if (response.index === 0 && response.direction === "up") {
          //   map.fitBounds(config.start.bounds);
          // }
        });
    </script>
  </body>
</html>
